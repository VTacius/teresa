<!DOCTYPE html>
<html>
    <head>
        <title> Mapa de Estado para dispositivos </title>
        <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin="" />
        <style type="text/css">
            html, body {
                height: 100%
            }

            #mapa {
                height: 100%;
            }
        </style>
    </head>
    <body>
        <div id="mapa"></div>
    </body>
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>
    <script type="text/javascript">
        // Los valores por defecto para el mapa
        var default_lat = "13.8054";
        var default_lng = "-88.9069";
        var default_zoom = 10;

        /**  Esto es básicamente la configuración inicial del mapa */
        var mapa = L.map('mapa').setView([default_lat, default_lng], default_zoom);

        /** Y esto hará que aparezca por arte de magia */
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(mapa);

        
        /** Aca empezamos con los datos */
        let uri = 'http://' + location.host + '/buzon';
        let sse = new EventSource(uri);
            
        function mostrarEstablecimientos(data) {
            let contenido = JSON.parse(data);
            contenido.forEach(point => {
                L.marker([point.latitude, point.longitude]).addTo(mapa)
                    .bindPopup('El servicio esta en algún estado que aún no nos han pasado');
                });
            

        }
        sse.onmessage = function(mensaje) {
            mostrarEstablecimientos(mensaje.data);
        }

    </script>
</html>
